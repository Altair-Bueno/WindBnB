---
import WindbnbLayout from "../../layouts/WindbnbLayout.astro";
import ViviendaComponent from "../../components/ViviendaComponent.astro";

import {
  GetViviendasRequest,
  ViviendaApi,
} from "../../api/A2viviendasREST/apis";

import { Configuration as ViviendaConfiguration } from "../../api/A2viviendasREST";

import AppConfig from "../../config";

const params = Astro.url.searchParams;

const titleFilter = params.get("title");
const priceMaxFilter = params.get("priceMax");
const priceMinFilter = params.get("priceMin");

const filter: GetViviendasRequest = {
  title: titleFilter ? titleFilter : undefined,
  priceMax: priceMaxFilter ? parseInt(priceMaxFilter) : undefined,
  priceMin: priceMinFilter ? parseInt(priceMinFilter) : undefined,
};

const viviendaApi = new ViviendaApi(
  new ViviendaConfiguration(AppConfig.viviendas)
);
const viviendas = await viviendaApi.getViviendas(filter);
---

<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<WindbnbLayout title="Viviendas" page={"HOME"}>
  <div class="row">
    <h1>Houses</h1>
    <aside class="col-12 col-xl-3 mb-2">
      <h4>Filters</h4>
      <form>
        <div class="mb-3">
          <label class="form-check-label">Search by title</label>
          <input
            type="text"
            name="title"
            value={filter.title}
            class="form-control"
          />
        </div>
        <div class="mb-3 h-100"></div>
        <label class="form-check-label">Price</label>
        <div class="row">
          <div class="col">
            <input
              type="number"
              name="priceMin"
              value={filter.priceMin}
              placeholder="min"
              class="form-control"
              min="1"
            />
          </div>
          <div class="col">
            <input
              type="number"
              name="priceMax"
              value={filter.priceMax}
              placeholder="max"
              class="form-control"
              min="1"
            />
          </div>
        </div>
        <button type="submit" class="btn btn-primary mt-3">Filter</button>
      </form>
    </aside>
    <div class="col d-flex flex-wrap">
      {
        viviendas
          .filter((x) => x.state === "available")
          .map((vivienda) => <ViviendaComponent vivienda={vivienda} />)
          .map((x) => <div class="mx-2">{x}</div>)
      }
    </div>
  </div>
</WindbnbLayout>
